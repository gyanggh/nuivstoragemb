# Nuistar Videostorage Final Writeup

The Nuistar Videostorage application is an application designed to take and store video files and associated metadata
such that they are available and searchable to teachers and peers. The application as delivered consists of two parts: the AWS Backend and Application Frontend
 
## AWS Backend

The AWS Backend contains the cloud services that store data and video files, as well as API endpoints that allow 
clients to add retrieve, edit and delete records. All operations to the AWS backend are done via HTTP requests.

### AWS Authentication

The first step for any client is to authenticate themselves with the AWS Cognito User Pool.
Documentation about how to do so is available [here](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-reference.html).
The user pool provides authentication services to the end user client. To do so, they require a client ID, generated by cognito. The client should then allow the user to log in, and retrieve credentials from AWS cognito identity pools. These credentials authenticate the user and allow them to use the following resources.
The user pool also serves to identify the teacher of any given student, as well as which users are teachers. This is done through an attribute claim labeled "teacher" on each user. If the teacher field is equivilant to the current username, then this user is a teacher, otherwise they are a student whose teacher is the user with the username in their teacher field.

### AWS Dynamodb

Most of the data of the backend is stored in AWS Dynamodb. A primary table stores data about video records: their id, owners,
teachers, available formats, etc.
This primary table is indexed by ID naturally, and has two important Global Secondary Indicies (GSIs): an index on users by timestamp, and an index on teachers by timestamp.
These two indicies are important to allow efficient retrieval of video data when there are many users and teachers.
A secondary table stores information about user events. It stores the type of event that occured: adding removing or editing videos, adding comments, etc; the user and teacher associated with this specific event; and enough information to uniquely identify the relevant record in the primary table. This table serves as both an audit log, to know who did what, as well as a way to generate a timeline of relevant events for a social-media like feed on the client. This table is currently unpopulated and non-functional due to unknown bugs.

### Lambda Endpoints

The backend uses AWS lambda to provide access to and populate records in dynamodb. AWS Lambda exposes several functions that are mapped either to API Endpoints (adressed in a later section), or AWS Service Events, to allow clients and other AWS services to interface with Dynamodb. It provides results in a JSON body, and request status using HTTP status codes. Currently, it only returns 400 for user error, but can be extended to be more informative. Currently, the Lambda provides all API endpoints to clients, as well as an endpoint for AWS S3 to report a successful file upload. It also has a nonfunctional hook to request transcoding of a given video object. The code can be found in the aws-lambda branch of the git repository provided.

### AWS S3

All video files are stored in an AWS S3 bucket. Clients authenticate with this bucket by signing their requests with the access tokens obtained from cognito authentication. Documentation on how to sign S3 requests can be found [here](https://docs.aws.amazon.com/AmazonS3/latest/dev/RESTAuthentication.html). Video files are stored in a single bucket, with the structure "{Teacher Username}/{User Username}/{Video ID}.{format}". S3 can handle files of basically any size.

In addition, a second S3 bucket exists with the demo client application. This is used to make it available to AWS Cloudfront for delivery to end users.

### AWS API Gateway

The AWS API Gateway exposes lambda functions to the client. The API gateway has integration with AWS Cognito: simply pass the JWT of your cognito session in a header labeled "Authorization", and the API gateway will authenticate you and provide this information to the lambda functions. Due to a limitation of the current client, the lambda functions will always treat your teacher field as "TestTeacher". In addition, the API gateway provides OPTIONS endpoints to ensure CORS compatibility. After providing CORS information and authenticating a request, the request is forwarded to the appropriate Lambda function, and the result is returned to the client. A more detailed API documentation will be included in a seperate document.

### AWS Cloudfront

AWS Cloudfront is a Content Delivery Network(CDN), used to deliver files from AWS to clients via HTTP. This application uses two Cloudfront distributions. The primary distribution is used to deliver the demo application to end users from S3. The secondary distribution is used to deliver video files from S3. Cloudfront provides a reliable CDN with a transparant cache, reducing costs associated with retrieving files from S3 and providing speedy delivery to users anywhere in the world. In addition, Cloudfront is configured with the appropriate redirects to serve the demo application, which, being a Single Page Application, requires some configuration and does not work smoothly being served directly from S3.

### Caveats, Planned Features and Bugs.

By far the biggest bug is the current stopgap measure of assigning every user a teacher of "TestTeacher". Due to limitations of the sign in page on the demo application, this is to work around users not being able to specify their teacher currently, and should be changed before this app is deployed to any production context.
Second, the user events table is currently not populated for unknown reasons, likely due to some configuration of node event queues on AWS Lambda. This functionality, while not absolutely nessacary, is likely useful and important to any educational organization wanting to ensure proper use of their student's data.
In addition, this application also suffers from several sever security weaknesses. CORS is configured on all publicly facing resources, but it is overly broad and should only allow authorized domains where client applications exist. Lambda functions do not have graceful handling of authorization errors, potentially leaking implementation information that reduces security. Permissions set on the AWS IAM roles associated with Cognito often have too many and too broad settings. The current S3 bucket is completely availble to public view: Ideally, the permissions of users and teachers should be checked, and each client should only be able to access resources within their domain. While the folder structure is set up to facilitate this, such permissions have not been implented yet. 
Additionally, two quality of life services are still missing: First, while the capability to automatically transcode videos exists in the form of AWS Elastic Transcoder, it has not been implemented. Once transcoding is implemented, users can get access to video thumbnails and more efficient and speedy video streaming via Cloudfront, as well as the ability to download videos in arbitrary formats. Second, currently there is no way for a client to know about fresh records in the cloud, and querying the API endpoints for those resources is relatively expensive. This means that clients have to ask the user to manually refresh to see new resources, a quality of life issue. A notifaction system could be achieved with AWS SNS, but has not yet been done.
Finally, convinent API endpoints for teachers and admins to manage cognito users do not yet exist. While management can be done, whether through Cognito's public facing api or from the management console, it is reccomended that some functions be implemented in the API gateway for clients to convinently manage said users.

### Summary

This collection of AWS services allows you to service clients needing to store and search video data. Because of its serverless nature, this application scales tremendously, allowing you to serve clients regardless of their size, without incurring up-front or time-based costs. By building on the secure, reliable implementation of AWS services, this application has a minimal codebase for bugs to exist in, resulting in a high uptime percentage and few issues with misconfigured servers.

## Demo Client

Also included is a demo client application. This application showcases the use of the backend, allowing users to upload, browse, and edit videos, as well as comment on them. It restricts this functionality until users sign up or sign in to AWS Cognito. Currently it cannot allow users to set their teacher, resulting in the workaround in the lambda functions described above. In addition, a social-media style feed is partially implemented, but not fully done because of issues with populating the event feed. Finally, it does not have any functionality for managing users for teachers/admin users. 
The application is implemented as a React Single Page Application, to be served anywhere, but ideally though AWS Cloudfront. It is designed to run on recent versions of Chrome and Firefox; while other browsers may be supported to an extent, it is by no means guarenteed. This application is found on the master branch of the git repository.
